name: Bump Chart Version

on: 
    workflow_call:
        inputs:
            chart-path:
                required: true
                type: string

  
jobs:
    version:
        runs-on: ubuntu-latest
        permissions:
            contents: write           # 'write' access to repository contents
            pull-requests: write      # 'write' access to pull requests
        steps:
        - name: Pull Repository
          uses: actions/checkout@v4
          with:
            ref: ${{ github.head_ref }}
            fetch-depth: 0
        - name: Get Previous Version Hash
          id: get_hash
          run: |
            COMMIT_HASH=$(git cherry -v "main" "${{ github.head_ref || github.ref_name }}" | grep "chore(release): chart:" | head -n 1 | awk '{print $2}')
            echo "::set-output name=hash::$COMMIT_HASH"
        - name: Remove Previous Version Hash
          if: ${{ steps.get_hash.outputs.hash != '' }}
          run: |
            COMMIT_HASH=${{ steps.get_hash.outputs.hash }}
            git rebase --onto $COMMIT_HASH^ $COMMIT_HASH

        - name: Conventional Changelog Action
          uses: TriPSs/conventional-changelog-action@v5
          with:
            github-token: ${{ secrets.github_token }}
            git-message: 'chore(release): chart: {version}'
            version-file: '${{ inputs.chart-path }}/Chart.yaml'
            output-file: '${{ inputs.chart-path }}/CHANGELOG.md'
            skip-on-empty: 'false'
            tag-prefix: ''
            create-summary: true
            skip-git-pull: true
            git-push: false
        - name: Push Changes
          uses: ad-m/github-push-action@master
          with:
            branch: ${{ github.head_ref }}
        